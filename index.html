<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Biomass Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@google/earthengine@0.1.321/build/earth-engine.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body { margin: 0; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: #1a2a3a; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .content { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .content { grid-template-columns: 1fr; } }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #map { height: 600px; width: 100%; border-radius: 5px; background: #e0e0e0; }
        .controls { margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        #initBtn { background: #2ecc71; }
        #initBtn:hover { background: #27ae60; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #333; }
        .status-overlay { padding: 10px; background: #fffbe6; border: 1px solid #ffe58f; border-radius: 4px; margin-top: 10px; font-size: 0.9em; }
        .loading { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Farm Biomass Dashboard</h1>
            <p>Satellite NDVI Insights & Paddock Data</p>
        </div>
        
        <div class="content">
            <div class="card">
                <div class="controls">
                    <button onclick="initGEE()" id="initBtn">1. Login to Google</button>
                    <button onclick="loadGeeMap()" id="mapBtn" disabled>2. Load NDVI Map</button>
                    <button onclick="loadBiomassData()">Refresh Biomass Data</button>
                </div>
                <div id="map"></div>
                <div class="status-overlay" id="mapStatus">Ready. Please initialize GEE to view satellite imagery.</div>
            </div>
            
            <div class="card">
                <h2>Biomass Standings</h2>
                <label for="cloudFilter">Cloud Tolerance:</label>
                <select id="cloudFilter" onchange="loadBiomassData()" style="padding: 5px; margin-bottom: 15px;">
                    <option value="40">Standard (≤40%)</option>
                    <option value="30">Strict (≤30%)</option>
                    <option value="50">Loose (≤50%)</option>
                </select>
                
                <div id="loading" class="loading" style="display:none;">Fetching Sheets data...</div>
                <table>
                    <thead>
                        <tr>
                            <th>Paddock</th>
                            <th>kg DM/ha</th>
                            <th>Last Reading</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const GEE_CLIENT_ID = '895621183163-ldkkoljnshjipv83jv4s91b2v3k7g7bk.apps.googleusercontent.com';
        const PADDOCKS_ASSET = 'projects/ndvi-project-484422/assets/myfarm_paddocks';
        const SHEETS_API = 'https://script.google.com/macros/s/AKfycbzZ9KgIFLPJThJEmjvERPzsAFbs7J0_rJt8N6ngAAkmLBDRDVGzyGZ8hcdvIiC0fRIr/exec';
        
        let map = null;
        let ndviLayer = null;

        // Initialize Leaflet
        document.addEventListener('DOMContentLoaded', () => {
            map = L.map('map').setView([-40.9006, 174.8860], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);
            loadBiomassData();
        });

        // 1. Authenticate with Google
        async function initGEE() {
    const status = document.getElementById('mapStatus');
    console.log("Initialize button clicked..."); // Check F12 console for this

    // 1. Check if the library is even loaded
    if (typeof ee === 'undefined') {
        alert("Earth Engine library failed to load. Check your internet or script tags.");
        return;
    }

    status.textContent = 'Attempting to open Google Login...';

    try {
        // Use the 'Popup' flow specifically
        ee.data.authenticateViaPopup(
            () => {
                console.log("OAuth Successful, initializing...");
                ee.initialize(null, null, 
                    () => {
                        status.textContent = 'Authenticated and Initialized!';
                        document.getElementById('initBtn').textContent = 'Logged In';
                        document.getElementById('mapBtn').disabled = false;
                    }, 
                    (err) => {
                        status.textContent = 'Initialization error: ' + err;
                    }
                );
            },
            (err) => {
                console.error("Popup Error:", err);
                status.textContent = 'Popup failed. Error: ' + JSON.stringify(err);
                alert("Popup blocked or Origin not authorized. Check the F12 console.");
            }
        );
    } catch (e) {
        status.textContent = 'Error: ' + e.message;
    }
}

        // 2. Load the NDVI Map from GEE
        async function loadGeeMap() {
            const status = document.getElementById('mapStatus');
            const mapBtn = document.getElementById('mapBtn');
            
            status.textContent = 'Processing latest satellite imagery...';
            mapBtn.disabled = true;

            try {
                const paddocks = ee.FeatureCollection(PADDOCKS_ASSET);
                
                // Get most recent S2 image (last 45 days)
                const s2 = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
                    .filterBounds(paddocks.geometry())
                    .filterDate(ee.Date(Date.now()).advance(-45, 'day'), ee.Date(Date.now()))
                    .filter(ee.Filter.lte('CLOUDY_PIXEL_PERCENTAGE', 40))
                    .sort('system:time_start', false)
                    .first();

                // Calculate NDVI
                const ndvi = s2.normalizedDifference(['B8', 'B4']).clip(paddocks);

                const viz = {
                    min: 0.25,
                    max: 0.85,
                    palette: ['#FFFFFF', '#CE7E10', '#DF9550', '#F1D155', '#228B22', '#004400']
                };

                // Get Map ID from GEE
                const mapId = await new Promise((resolve, reject) => {
                    ndvi.getMapId(viz, (res, err) => res ? resolve(res) : reject(err));
                });

                // Clear old layer if it exists
                if (ndviLayer) map.removeLayer(ndviLayer);

                // Add to Leaflet
                const url = `https://earthengine.googleapis.com/map/${mapId.mapid}/{z}/{x}/{y}?token=${mapId.token}`;
                ndviLayer = L.tileLayer(url, { attribution: 'Google Earth Engine | Sentinel-2' }).addTo(map);

                // Add Paddock Outlines
                const outline = ee.Image().byte().paint(paddocks, 1, 2);
                const outlineId = await new Promise((resolve, reject) => {
                    outline.getMapId({palette: ['#00FFFF']}, (res, err) => res ? resolve(res) : reject(err));
                });
                L.tileLayer(`https://earthengine.googleapis.com/map/${outlineId.mapid}/{z}/{x}/{y}?token=${outlineId.token}`).addTo(map);

                // Zoom to Paddocks
                paddocks.getBounds((bounds) => {
                    const c = bounds.coordinates[0];
                    map.fitBounds([[c[0][1], c[0][0]], [c[2][1], c[2][0]]]);
                });

                status.textContent = 'NDVI Map Loaded Successfully.';
                mapBtn.disabled = false;
            } catch (err) {
                console.error(err);
                status.textContent = 'Error: ' + err.message;
                mapBtn.disabled = false;
            }
        }

        // 3. Biomass Table Logic (from Google Sheets)
        async function loadBiomassData() {
            const loading = document.getElementById('loading');
            const tableBody = document.getElementById('tableBody');
            loading.style.display = 'block';
            tableBody.innerHTML = '';

            try {
                const cloud = document.getElementById('cloudFilter').value;
                const response = await fetch(`${SHEETS_API}?sheet=Biomass_Standard_${cloud}pc`);
                const result = await response.json();
                const data = result.data || result;

                data.sort((a, b) => (b['Est. kg DM/ha'] || 0) - (a['Est. kg DM/ha'] || 0));

                data.forEach(item => {
                    const row = `<tr>
                        <td>${item['Paddock Name'] || 'N/A'}</td>
                        <td><strong>${Math.round(item['Est. kg DM/ha'] || 0).toLocaleString()}</strong></td>
                        <td>${(item['Date of Reading'] || '').split('T')[0]}</td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
            } catch (err) {
                tableBody.innerHTML = '<tr><td colspan="3">Error loading spreadsheet data.</td></tr>';
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>

