<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Biomass Dashboard</title>
    
    <script src="https://ajax.googleapis.com/ajax/libs/earthengine/0.1.321/ee_api_js.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body { margin: 0; padding: 20px; font-family: sans-serif; background: #f4f4f4; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #map { height: 500px; width: 100%; border-radius: 4px; border: 1px solid #ccc; }
        .btn { padding: 10px 20px; cursor: pointer; background: #27ae60; color: white; border: none; border-radius: 4px; font-weight: bold; }
        .btn:disabled { background: #95a5a6; }
        #status { padding: 10px; background: #eee; border-radius: 4px; margin-top: 10px; font-family: monospace; }
    </style>
</head>
<body>

    <div class="card">
        <h1>Farm Biomass Dashboard</h1>
        <button id="loginBtn" class="btn" onclick="startLogin()">Login to Google Earth Engine</button>
        <button id="mapBtn" class="btn" onclick="loadMap()" disabled style="background: #2980b9;">Load NDVI Map</button>
        <div id="status">Status: Waiting for user...</div>
    </div>

    <div class="card">
        <div id="map"></div>
    </div>

    <script>
        // CONFIG
        const CLIENT_ID = '895621183163-ldkkoljnshjipv83jv4s91b2v3k7g7bk.apps.googleusercontent.com';
        const ASSET_ID = 'projects/ndvi-project-484422/assets/myfarm_paddocks';
        
        let map;

        // Initialize Map on start
        window.onload = function() {
            map = L.map('map').setView([-40.9, 174.8], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            // Check if library loaded
            if (typeof ee === 'undefined') {
                document.getElementById('status').innerHTML = "ERROR: Earth Engine Library NOT loaded. Check internet.";
                document.getElementById('status').style.color = "red";
            } else {
                document.getElementById('status').innerHTML = "Library loaded. Ready to login.";
            }
        };

        function startLogin() {
            const status = document.getElementById('status');
            status.innerHTML = "Attempting to open popup...";

            try {
                // Ensure popups are allowed!
                ee.data.authenticateViaPopup(
                    function() {
                        status.innerHTML = "OAuth Success! Initializing...";
                        ee.initialize(null, null, function() {
                            status.innerHTML = "CONNECTED: Ready to load farm map.";
                            document.getElementById('mapBtn').disabled = false;
                            document.getElementById('loginBtn').style.background = "#bdc3c7";
                        }, function(err) {
                            status.innerHTML = "Init Error: " + err;
                        });
                    },
                    function(err) {
                        status.innerHTML = "Popup Error: " + JSON.stringify(err);
                        console.error(err);
                    }
                );
            } catch (e) {
                status.innerHTML = "Exception: " + e.message;
            }
        }

        async function loadMap() {
            const status = document.getElementById('status');
            status.innerHTML = "Loading satellite imagery...";
            
            try {
                const paddocks = ee.FeatureCollection(ASSET_ID);
                const s2 = ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED")
                    .filterBounds(paddocks.geometry())
                    .sort('system:time_start', false)
                    .first();

                const ndvi = s2.normalizedDifference(['B8', 'B4']).clip(paddocks);
                const viz = {min: 0.2, max: 0.8, palette: ['white', 'brown', 'yellow', 'green', 'darkgreen']};
                
                const mapId = await new Promise((resolve, reject) => {
                    ndvi.getMapId(viz, (res, err) => res ? resolve(res) : reject(err));
                });

                const url = `https://earthengine.googleapis.com/map/${mapId.mapid}/{z}/{x}/{y}?token=${mapId.token}`;
                L.tileLayer(url).addTo(map);
                
                status.innerHTML = "Map loaded successfully!";
            } catch (err) {
                status.innerHTML = "Map Error: " + err;
            }
        }
    </script>
</body>
</html>
